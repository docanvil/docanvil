<!DOCTYPE html>
<html lang="en">
<head>
  {% if color_mode == "both" %}
  <script>(function(){var t=localStorage.getItem('docanvil-theme');if(t==='dark'||t==='light'){document.documentElement.setAttribute('data-theme',t)}})();</script>
  {% elif color_mode == "dark" %}
  <script>document.documentElement.setAttribute('data-theme','dark');</script>
  {% endif %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#6366f1">
  <title>{{ page_title }} â€” {{ project_name }}</title>
  {% if meta_description %}
  <meta name="description" content="{{ meta_description }}">
  <meta property="og:description" content="{{ meta_description }}">
  {% endif %}
  {% if meta_author %}
  <meta name="author" content="{{ meta_author }}">
  {% endif %}
  {% if meta_date %}
  <meta property="article:published_time" content="{{ meta_date }}">
  {% endif %}
  <meta property="og:title" content="{{ page_title }}">
  <meta property="og:type" content="article">
  <style>{{ default_css | safe }}</style>
  {% if css_overrides %}
  <style>:root { {{ css_overrides }} }</style>
  {% endif %}
  {% if favicon_path %}
  <link rel="icon" href="{{ favicon_path }}">
  {% endif %}
  {% if custom_css %}
  <style>{{ custom_css | safe }}</style>
  {% endif %}
  {% block head %}{% endblock %}
</head>
<body>
  {% block header %}
  <header class="top-header">
    <div class="top-header-left">
      <button class="mobile-nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
        <svg class="mobile-nav-icon-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        <svg class="mobile-nav-icon-close" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      {% if logo_path %}
      <img class="top-header-logo" src="{{ logo_path }}" alt="{{ project_name }} logo">
      {% endif %}
      <span class="top-header-name">{{ project_name }}</span>
    </div>
    <div class="top-header-right">
      {% if search_enabled %}
      <button class="search-trigger" aria-label="Search documentation">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <span class="search-trigger-text">Search...</span>
        <kbd class="search-trigger-kbd">/</kbd>
      </button>
      {% endif %}
      {% if color_mode == "both" %}
      <button class="theme-toggle" aria-label="Toggle dark mode">
        <svg class="theme-icon-light" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg class="theme-icon-dark" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
      {% endif %}
    </div>
  </header>
  {% endblock %}

  {% block sidebar %}
  <nav class="sidebar">
    {{ nav_html | safe }}
  </nav>
  {% endblock %}

  <main class="content">
    {% block content %}
    {{ content | safe }}
    {% endblock %}

    {% if prev_page or next_page %}
    <nav class="prev-next" aria-label="Page navigation">
      {% if prev_page %}
      <a class="prev-next-link prev-next-prev" href="{{ prev_page.url }}">
        <span class="prev-next-label">Previous</span>
        <span class="prev-next-title">{{ prev_page.title }}</span>
      </a>
      {% else %}
      <span></span>
      {% endif %}
      {% if next_page %}
      <a class="prev-next-link prev-next-next" href="{{ next_page.url }}">
        <span class="prev-next-label">Next</span>
        <span class="prev-next-title">{{ next_page.title }}</span>
      </a>
      {% endif %}
    </nav>
    {% endif %}

    {% block footer %}
    <div class="footer">
      Built with <a href="https://github.com/docanvil/docanvil">DocAnvil</a>
    </div>
    {% endblock %}
  </main>

  <aside class="toc">
    <nav class="toc-nav" aria-label="Table of contents"></nav>
  </aside>

  {% if search_enabled %}
  <div class="search-overlay" aria-modal="true" role="dialog" aria-label="Search documentation">
    <div class="search-overlay-backdrop"></div>
    <div class="search-overlay-panel">
      <div class="search-overlay-header">
        <svg class="search-overlay-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" class="search-overlay-input" placeholder="Search documentation..." aria-label="Search documentation" autocomplete="off">
        <kbd class="search-overlay-esc">Esc</kbd>
      </div>
      <div class="search-overlay-results"></div>
    </div>
  </div>
  {% endif %}

  {% block scripts %}
  <script>
  // Tab switching
  document.querySelectorAll('.tab-header').forEach(btn => {
    btn.addEventListener('click', () => {
      const container = btn.closest('.tabs, .code-group');
      const tab = btn.dataset.tab;
      container.querySelectorAll('.tab-header').forEach(b => b.classList.remove('active'));
      container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      container.querySelector(`.tab-content[data-tab="${tab}"]`).classList.add('active');
    });
  });

  // Sidebar collapse/expand
  document.querySelectorAll('.nav-group-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const group = btn.closest('.nav-group');
      const expanded = group.classList.toggle('open');
      btn.setAttribute('aria-expanded', expanded);
    });
  });

  // Clickable heading anchor links
  document.querySelectorAll('.content h1[id], .content h2[id], .content h3[id], .content h4[id], .content h5[id], .content h6[id]').forEach(heading => {
    const link = document.createElement('a');
    link.className = 'heading-anchor';
    link.href = '#' + heading.id;
    link.setAttribute('aria-label', 'Link to this heading');
    link.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>';
    heading.appendChild(link);
  });

  // Copy button on code blocks
  document.querySelectorAll('.content pre:not(.mermaid)').forEach(pre => {
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.setAttribute('aria-label', 'Copy code');
    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
    pre.appendChild(btn);

    btn.addEventListener('click', () => {
      const code = pre.querySelector('code');
      const text = (code || pre).textContent;
      navigator.clipboard.writeText(text).then(() => {
        btn.classList.add('copied');
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
        }, 2000);
      });
    });
  });

  // Popover edge-avoidance
  document.querySelectorAll('.popover-trigger').forEach(trigger => {
    const popover = trigger.querySelector('.popover-content');
    if (!popover) return;

    function reposition() {
      // Reset positioning classes
      popover.classList.remove('popover-flipped');
      popover.style.left = '';
      popover.style.transform = '';

      const triggerRect = trigger.getBoundingClientRect();
      const popoverRect = popover.getBoundingClientRect();

      // Flip below if overflowing top
      if (popoverRect.top < 0) {
        popover.classList.add('popover-flipped');
      }

      // Shift horizontally if overflowing edges
      const updated = popover.getBoundingClientRect();
      if (updated.left < 8) {
        const shift = 8 - updated.left;
        popover.style.left = `calc(50% + ${shift}px)`;
      } else if (updated.right > window.innerWidth - 8) {
        const shift = updated.right - (window.innerWidth - 8);
        popover.style.left = `calc(50% - ${shift}px)`;
      }
    }

    trigger.addEventListener('mouseenter', reposition);
    trigger.addEventListener('focusin', reposition);
  });

  // Mobile navigation toggle
  (function() {
    const toggle = document.querySelector('.mobile-nav-toggle');
    const sidebar = document.querySelector('.sidebar');
    if (!toggle || !sidebar) return;

    toggle.addEventListener('click', () => {
      const isOpen = sidebar.classList.toggle('mobile-open');
      document.body.classList.toggle('nav-open', isOpen);
      toggle.setAttribute('aria-expanded', isOpen);
    });

    document.addEventListener('click', (e) => {
      if (sidebar.classList.contains('mobile-open') &&
          !sidebar.contains(e.target) &&
          !toggle.contains(e.target)) {
        sidebar.classList.remove('mobile-open');
        document.body.classList.remove('nav-open');
        toggle.setAttribute('aria-expanded', 'false');
      }
    });
  })();

  // Table of contents
  (function() {
    const tocNav = document.querySelector('.toc-nav');
    if (!tocNav) return;
    const headings = document.querySelectorAll('.content h2[id], .content h3[id]');
    if (headings.length < 2) {
      tocNav.closest('.toc').style.display = 'none';
      return;
    }

    const ul = document.createElement('ul');
    ul.className = 'toc-list';
    headings.forEach(h => {
      const li = document.createElement('li');
      li.className = 'toc-item' + (h.tagName === 'H3' ? ' toc-h3' : '');
      const a = document.createElement('a');
      a.href = '#' + h.id;
      a.textContent = h.textContent.replace(/\s*#$/, '');
      li.appendChild(a);
      ul.appendChild(li);
    });
    tocNav.appendChild(ul);

    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocNav.querySelectorAll('.toc-item').forEach(item => item.classList.remove('active'));
          const active = tocNav.querySelector(`a[href="#${entry.target.id}"]`);
          if (active) active.parentElement.classList.add('active');
        }
      });
    }, { rootMargin: '-80px 0px -70% 0px' });

    headings.forEach(h => observer.observe(h));
  })();

  // Theme toggle (light/dark)
  (function() {
    var toggle = document.querySelector('.theme-toggle');
    if (!toggle) return;

    var iconLight = toggle.querySelector('.theme-icon-light');
    var iconDark = toggle.querySelector('.theme-icon-dark');

    function getEffectiveTheme() {
      var stored = localStorage.getItem('docanvil-theme');
      if (stored === 'dark' || stored === 'light') return stored;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      if (iconLight && iconDark) {
        iconLight.style.display = theme === 'dark' ? 'none' : 'block';
        iconDark.style.display = theme === 'dark' ? 'block' : 'none';
      }
    }

    applyTheme(getEffectiveTheme());

    toggle.addEventListener('click', function() {
      var current = getEffectiveTheme();
      var next = current === 'dark' ? 'light' : 'dark';
      localStorage.setItem('docanvil-theme', next);
      applyTheme(next);
    });

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
      if (!localStorage.getItem('docanvil-theme')) {
        applyTheme(getEffectiveTheme());
      }
    });
  })();
  </script>
  {% endblock %}

  {% if search_enabled %}
  <script>
  (function() {
    var overlay = document.querySelector('.search-overlay');
    var backdrop = document.querySelector('.search-overlay-backdrop');
    var input = document.querySelector('.search-overlay-input');
    var resultsContainer = document.querySelector('.search-overlay-results');
    var trigger = document.querySelector('.search-trigger');
    if (!overlay || !input || !resultsContainer) return;

    var miniSearch = null;
    var loaded = false;
    var selectedIndex = -1;

    function getSnippet(body, query, maxLen) {
      if (!body) return '';
      var lower = body.toLowerCase();
      var terms = query.toLowerCase().split(/\s+/).filter(Boolean);
      var pos = -1;
      for (var t = 0; t < terms.length; t++) {
        pos = lower.indexOf(terms[t]);
        if (pos >= 0) break;
      }
      if (pos < 0) return body.slice(0, maxLen) + (body.length > maxLen ? '...' : '');
      var start = Math.max(0, pos - 60);
      var end = Math.min(body.length, pos + maxLen - 60);
      var snippet = (start > 0 ? '...' : '') + body.slice(start, end) + (end < body.length ? '...' : '');
      for (var t = 0; t < terms.length; t++) {
        var re = new RegExp('(' + terms[t].replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
        snippet = snippet.replace(re, '<mark>$1</mark>');
      }
      return snippet;
    }

    function escapeHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function loadSearch() {
      if (loaded) return;
      loaded = true;
      var script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/minisearch@7/dist/umd/index.min.js';
      script.onload = function() {
        fetch('{{ base_url | safe }}search-index.json')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            miniSearch = new MiniSearch({
              fields: ['title', 'heading', 'body'],
              storeFields: ['title', 'heading', 'url', 'body', 'breadcrumbs'],
              searchOptions: {
                boost: { title: 3, heading: 2 },
                prefix: true,
                fuzzy: 0.2
              }
            });
            miniSearch.addAll(data);
            if (input.value) doSearch(input.value);
          });
      };
      document.head.appendChild(script);
    }

    function openOverlay() {
      loadSearch();
      overlay.classList.add('open');
      document.body.style.overflow = 'hidden';
      input.focus();
    }

    function closeOverlay() {
      overlay.classList.remove('open');
      document.body.style.overflow = '';
      input.value = '';
      resultsContainer.innerHTML = '';
      selectedIndex = -1;
    }

    function doSearch(query) {
      selectedIndex = -1;
      if (!miniSearch || !query.trim()) {
        resultsContainer.innerHTML = query.trim() && !miniSearch ? '<div class="search-no-results">Loading...</div>' : '';
        return;
      }
      var results = miniSearch.search(query).slice(0, 10);
      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="search-no-results">No results found</div>';
        return;
      }
      resultsContainer.innerHTML = results.map(function(r, i) {
        var trail = r.breadcrumbs && r.breadcrumbs.length ? r.breadcrumbs.slice() : [r.title];
        if (r.heading) trail.push(r.heading);
        var titleText = '';
        for (var t = 0; t < trail.length; t++) {
          if (t > 0) titleText += '<span class="search-result-separator search-result-breadcrumb">&rsaquo;</span>';
          if (t < trail.length - 1) {
            titleText += '<span class="search-result-breadcrumb">' + escapeHtml(trail[t]) + '</span>';
          } else {
            titleText += escapeHtml(trail[t]);
          }
        }
        var snippet = getSnippet(r.body || '', query, 140);
        return '<a class="search-result-item" href="' + r.url + '" role="option" data-index="' + i + '">' +
          '<div class="search-result-title">' + titleText + '</div>' +
          (snippet ? '<div class="search-result-snippet">' + snippet + '</div>' : '') +
          '</a>';
      }).join('');
    }

    function updateSelection() {
      var items = resultsContainer.querySelectorAll('.search-result-item');
      items.forEach(function(item, i) {
        item.classList.toggle('selected', i === selectedIndex);
      });
      if (selectedIndex >= 0 && items[selectedIndex]) {
        items[selectedIndex].scrollIntoView({ block: 'nearest' });
      }
    }

    if (trigger) {
      trigger.addEventListener('click', openOverlay);
    }

    backdrop.addEventListener('click', closeOverlay);

    input.addEventListener('input', function() { doSearch(input.value); });

    input.addEventListener('keydown', function(e) {
      var items = resultsContainer.querySelectorAll('.search-result-item');
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        updateSelection();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection();
      } else if (e.key === 'Enter' && selectedIndex >= 0 && items[selectedIndex]) {
        e.preventDefault();
        items[selectedIndex].click();
      } else if (e.key === 'Escape') {
        e.preventDefault();
        closeOverlay();
      }
    });

    resultsContainer.addEventListener('click', function(e) {
      if (e.target.closest('.search-result-item')) {
        closeOverlay();
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === '/' && !overlay.classList.contains('open')) {
        var tag = (e.target.tagName || '').toLowerCase();
        if (tag === 'input' || tag === 'textarea' || tag === 'select' || e.target.isContentEditable) return;
        e.preventDefault();
        openOverlay();
      }
      if (e.key === 'Escape' && overlay.classList.contains('open')) {
        closeOverlay();
      }
    });
  })();
  </script>
  {% endif %}

  {% if mermaid_enabled %}
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@{{ mermaid_version }}/dist/mermaid.esm.min.mjs';

    function hexToRgb(hex) {
      hex = hex.replace('#', '');
      if (hex.length === 3) hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
      var n = parseInt(hex, 16);
      return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 };
    }

    function mixHex(hex1, hex2, factor) {
      var c1 = hexToRgb(hex1), c2 = hexToRgb(hex2);
      var r = Math.round(c1.r + (c2.r - c1.r) * factor);
      var g = Math.round(c1.g + (c2.g - c1.g) * factor);
      var b = Math.round(c1.b + (c2.b - c1.b) * factor);
      return '#' + ((1 << 24) | (r << 16) | (g << 8) | b).toString(16).slice(1);
    }

    function resolveVar(name) {
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function getMermaidConfig() {
      var primary     = resolveVar('--color-primary') || '#6366f1';
      var bg          = resolveVar('--color-bg') || '#ffffff';
      var text        = resolveVar('--color-text') || '#1e293b';
      var border      = resolveVar('--color-border') || '#e2e8f0';
      var bgSecondary = resolveVar('--color-bg-secondary') || '#f8fafc';
      var textMuted   = resolveVar('--color-text-muted') || '#64748b';
      var fontFamily  = resolveVar('--font-body') || 'system-ui, sans-serif';
      var mainBkg     = mixHex(primary, bg, 0.88);

      return {
        startOnLoad: false,
        theme: 'base',
        themeVariables: {
          primaryColor: mainBkg,
          primaryTextColor: text,
          primaryBorderColor: primary,
          lineColor: textMuted,
          secondaryColor: bgSecondary,
          secondaryTextColor: text,
          secondaryBorderColor: border,
          tertiaryColor: bg,
          tertiaryTextColor: text,
          tertiaryBorderColor: border,
          background: bg,
          mainBkg: mainBkg,
          textColor: text,
          nodeTextColor: text,
          labelTextColor: text,
          nodeBorder: primary,
          clusterBkg: bgSecondary,
          clusterBorder: border,
          edgeLabelBackground: bg,
          fontFamily: fontFamily,
          fontSize: '14px'
        }
      };
    }

    async function renderMermaid() {
      mermaid.initialize(getMermaidConfig());
      // Reset any previously rendered diagrams so mermaid will re-process them
      document.querySelectorAll('.mermaid[data-processed]').forEach(function(el) {
        el.removeAttribute('data-processed');
        el.innerHTML = el.getAttribute('data-original') || el.textContent;
      });
      // Store original source before first render
      document.querySelectorAll('.mermaid:not([data-original])').forEach(function(el) {
        el.setAttribute('data-original', el.textContent);
      });
      await mermaid.run();
    }

    // Initial render
    await renderMermaid();

    // Re-render when theme changes
    new MutationObserver(function(mutations) {
      for (var m of mutations) {
        if (m.attributeName === 'data-theme') {
          renderMermaid();
          break;
        }
      }
    }).observe(document.documentElement, { attributes: true });
  </script>
  {% endif %}

  {% if live_reload %}
  <script>
  (function() {
    const ws = new WebSocket(`ws://${location.host}/__docanvil_ws`);
    ws.onmessage = () => location.reload();
    ws.onclose = () => setTimeout(() => location.reload(), 1000);
  })();
  </script>
  {% endif %}
</body>
</html>
